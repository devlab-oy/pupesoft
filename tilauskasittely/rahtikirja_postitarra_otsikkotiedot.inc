<?php

//Luodaan tarvittavat muuttujat rahtikirja_postitarra_pdf.inc

if ($phpnimi == "rahtikirja_custom.php") {
  $postirow = $osoitelappurow;
  $rakir_row = $osoitelappurow;
}
else {
  $query = "SELECT * from lasku where yhtio = '$kukarow[yhtio]' and tunnus in ($otunnukset) order by tunnus limit 1";
  $tempr = pupe_query($query);
  $postirow = mysql_fetch_array($tempr);
}

// haetaan varaston osoitetiedot, k‰ytet‰‰n niit‰ l‰hetystietoina
$query = "SELECT nimi, nimitark, osoite, postino, postitp, maa
          FROM varastopaikat
          WHERE yhtio = '$kukarow[yhtio]'
          AND tunnus  = '$postirow[varasto]'";
$tempr = pupe_query($query);
$postirow_varasto = mysql_fetch_array($tempr);

// jos varastolle on annettu joku osoite, k‰ytet‰‰n sit‰
if ($postirow_varasto["nimi"] != "") {
  $postirow["yhtio_nimi"]     = $postirow_varasto["nimi"];
  $postirow['yhtio_nimitark']  = $postirow_varasto["nimitark"];
  $postirow["yhtio_osoite"]   = $postirow_varasto["osoite"];
  $postirow["yhtio_postino"]  = $postirow_varasto["postino"];
  $postirow["yhtio_postitp"]  = $postirow_varasto["postitp"];
  $postirow["yhtio_maa"]      = $postirow_varasto["maa"];
}

// jos meill‰ on printterin takana joku spessu osoitetieto niin k‰ytet‰‰n sen tietoja l‰hett‰j‰n tietoina
if ($print["nimi"] != "") {
  $postirow["yhtio_nimi"]    = $print["nimi"];
  $postirow["yhtio_osoite"]  = $print["osoite"];
  $postirow["yhtio_postino"] = $print["postino"];
  $postirow["yhtio_postitp"] = $print["postitp"];
}

if ($postirow['rahtisopimus']=='') $postirow['rahtisopimus'] = "000000";
if ($toitarow['sopimusnro']=='')   $toitarow['sopimusnro']   = "000000";

// postiennakko
if ($rakir_row["jv"] != '' or $mehto['jv'] != '') {
  $postiennakkomaara  = "$yhteensa $postirow[valkoodi]";
  if ($yhtiorow["pankkiiban1"] != '') {
    $postiennakkotilino = "$yhtiorow[pankkiiban1]";
  }
  else {
    $postiennakkotilino = "$yhtiorow[pankkitili1]";
  }
  $postiennakkobic  = "$yhtiorow[pankkiswift1]";
  $postiennakkoviite  = "$viite";
}
else {
  $postiennakkomaara  = "";
  $postiennakkotilino = "";
  $postiennakkobic  = "";
  $postiennakkoviite  = "";
}

// Lis‰palvelut
//3101  1   Postiennakko  13)
//3103  3   Maksaja muu kuin l‰hett‰j‰  1)
//3104  4   Erillisk‰sitelt‰v‰
//3105  5   Kirjaaminen
//3106  6   Lauantaijakelu
//3107  7   Kuljetusyksikkˆ  (8)
//
//3108  8   Vastaanottajan nimitiedon tallennus  10)
//3115  15  T‰sm‰paikkajakelu  1)
//3118  18  Vaihtokuljetus  1)
//3119  19  Hyllytyspalvelu  1)
//3127  27  Laiteasennus  1) 3)
//3131  31  2. laiteasennus  1) 3)
//3132  32  3. Laiteasennus  1) 3)
//3133  33  Iso laiteasennus  1) 3)
//3134  34  Tietokoneasennus  1) 3)
//3135  35  TV:n sein‰asennus  1) 3)
//3136  36  Kantoapu  1) 3)
//3137  37  Kuljetus kierr‰tykseen  1) 3)
//3138  38  Purku pakkauksesta  1) 3)
//3139      S‰hkˆinen saapumisilmoitus 1) 6)
//3140      Vaihtoehtoinen noutopiste  1) 11)

// 1)  Palvelussa on k‰ytett‰v‰ EDI-sanomaa.
// 2)  Tuotekoodi tulostetaan osoitekorttiin selv‰kielisen‰ tekstin‰ ja code 128 viivakoodina, tuotekoodi ilmoitetaan myˆs EDI-sanomassa ilman 2W-alkutunnistetta.
// 3)  Asennus lis‰palvelujen k‰yttˆlogiikka avataan erillisess‰ ohjeessa.
// 4)  Lis‰palvelukoodi ilmoitetaan EDI-sanomassa, lis‰palvelukoodit 3115 - 3138 tulostetaan osoitekortin alaosaan sulkuihin lis‰palvelun nimen per‰‰n.
// 5)  Tulostetaan osoitekortin lis‰palveluruutuun.
// 6)  S‰hkˆinen saapumisilmoitus on Economy 16 ja Express Point 00/16 palveluihin kuuluva valinnainen ominaisuus.
//    Osoitekorttiin tulostetaan EDI SSI-merkint‰  ja Saapumisilmoitus korvataan Kuittiosalla tai irrotettava osa voidaan sovittaessa j‰tt‰‰ pois.
//     S‰hkˆinen saapumisilmoitus ilmoitetaan EDI sanomassa lis‰palvelukoodilla 3139.
// 7)  Vastaanottajan puhelinnumero tulee tulostaa osoitekorttiin ja se ilmoitetaan myˆs EDI-sanomassa.
// 8)  Pakollinen lis‰palvelu
// 9)  Palvelussa tulee k‰ytt‰‰ S‰hkˆinen saapumisilmoitus palvelua (EDI SSI).
// 10)  Vastaanottajan nimitiedon tallennus on palveluun kuuluva ominaisuus, osoitekorttiin ei tulosteta palveluun liittyvi‰ merkintˆj‰, poikkeuksena Express Point ja Economy palvelu.
// 11)  Vaihtoehtoinen noutopiste palvelussa l‰hett‰j‰n tulostusohjelmistossa tulee olla asiaan liittyv‰ noutopaikkarekisteri.
//    Osoitekortilla vaihtoehtoinen noutopiste n‰kyy vain osoitemerkinnˆiss‰ , katso malli.
//     Vaihtoehtoinen noutopiste palvelussa EDI-sanomassa ilmoitetaan lis‰palvelukoodi 3140, se poistaa S‰hkˆinen saapumisilmoitus palveluun kuuluvan iPost ominaisuuden.
// 12)  Posti Green kuuluu palvelujemme ominaisuuteen. "Posti Green - ilmastoyst‰v‰llinen kuljetus" tai "Posti Green - climate friendly delivery" nimen voi tulostaa
//    12 pisteen lihavoidun kirjaimin osoitekortin alaosan Lis‰tiedot -kentt‰‰n.
// 13)  Postiennakkol‰hetyser‰n (edellytt‰‰ EDI-tietoja) jokaiseen l‰hetykseen kiinnitet‰‰n osoitekortti t‰ydellisen‰ yksilˆiv‰‰ l‰hetystunnusta lukuun ottamatta samansis‰ltˆisen‰.
//    Postiennakkoer‰n kokonaissumma ja kokonaiskappalem‰‰r‰ (kpl st. kentt‰‰n)
//      merkit‰‰n er‰n jokaiseen osoitekorttiin. Postiennakkol‰hetyser‰n EDI-sanomassa ilmoitetaan myˆs lis‰palvelutunnus 3102. Kappalem‰‰r‰rajaus paketeille on 2-10 ja kuljetusyksikˆille 2-99.
// HUOM:  Samalle vastaanottajalle osoitetun l‰hetyser‰n (MPS, edellytt‰‰ EDI-tietoja) tietoja ei tulosteta osoitekorttiin,
//    mutta ne ilmoitetaan EDI -sanomassa. Poikkeuksena Postiennakko, katso selite 13.

$x = $x_tekstit = $x_tekstit_koko = array();

if ($yhteensa != '') {
  $x[]='1'; // Postiennakko
  $x_tekstit[1] = $x_tekstit_koko[1] = 'POSTIENNAKKO';
}

if ($kollityht>1) {
  $x[]='2'; // Monipakettil‰hetys
  $x_tekstit[2] = 'MONIPAKETTILƒH.';
  $x_tekstit_koko[2] = 'MONIPAKETTILƒHETYS';
}

if ($rakir_row['merahti'] != 'K') {
  $x[]='3'; // Maksaja muu kuin l‰hett‰j‰
  $x_tekstit[3] = 'MAKSAJA MUU';
  $x_tekstit_koko[3] = 'MAKSAJA MUU KUIN LƒHETTƒJƒ';
}

if ($toitarow['erilliskasiteltavakulu'] != 0) {
  $x[]='4'; // Erillisk‰sitelt‰v‰
  $x_tekstit[4] = 'ERILLISKƒSIT.';
  $x_tekstit_koko[4] = 'ERILLISKƒSITELTƒVƒ';
}

if ($toitarow['lauantai'] != '') {
  $x[]='6'; // lauantaijakelu
  $x_tekstit[6] = $x_tekstit_koko[6] = 'LAUANTAIJAKELU';
}

if ($toitarow['kuljyksikko'] != '') {
  $x[]='7'; // kuljetusyksikkˆkuljetus
  $x_tekstit[7] = $x_tekstit_koko[7] = 'KULJETUSYKSIKK÷';
}

$selite_chk = $toitarow['virallinen_selite'] != '' ? $toitarow['virallinen_selite'] : $toitarow['selite'];

// Oletuksena: Posti Express-paketti 14
$keltainen   = "Express-paketti";
$kuljetus    = "";
$keku     = "14";

if (strpos($selite_chk, "Aamuksi")     !== FALSE)         $keku = "9";
if (strpos($selite_chk, "Samana")    !== FALSE)         $keku = "00";
if (strpos($selite_chk, "Postipaketti")    !== FALSE)         $keku = "16";
if (strpos($selite_chk, "Kotipaketti")    !== FALSE)         $keku = "21";
if (strpos($selite_chk, "Illaksi")    !== FALSE)         $keku = "21";
if (strpos($selite_chk, "00/16") !== FALSE)         $keku = "00/16";
if (strpos($selite_chk, "Undelivered Shipment") !== FALSE)   $keku = "UNDELIVERED SHIPMENT";
if (strpos($selite_chk, "Lis‰arvokuljetus") !== FALSE)     $keku = "LISƒARVOKULJETUS";
if (strpos($selite_chk, "Priority") !== FALSE)     $keku = "PRIORITY";

// Jos on vaarallisia aineita, niin tulostetaan aina VAK/ADR-kortti
if (count($vakit) > 0) {
  $keku    = "VV";
  $selite_chk  = "VAK/ADR";
}

if ($selite_chk != '') {
  $keltainen = str_replace($keku, '', $selite_chk);
  $kuljetus  = '';
}

//Express City 00      2W2124
//Express Morning 9      2W2101
//Express Business Day 14  2W2102
//Express Point 00/16    2W2105
//Economy 16          2W2103
//Express Flex 21      2W2104
//VAK/ADR           2W2116
//Lis‰arvokuljetus        2W2150
//Asiakaspalautus 14      2W2108
//Priority Ulkomaa      2W2015

// UUDET
//Pikkupaketti  2W2461
//Postipaketti  2W2103
//Kotipaketti 2W2104
//Palautus  2W2108
//Express-paketti 2W102
//Express-paketti Aamuksi 09  2W101
//Express-paketti Samana P‰iv‰n‰ 00 2W2124

//Priority  2W2015

switch ($keku) {
case "Samana":
  $tuoteviiva1="2W2124";
  break;
case "Aamuksi":
  $tuoteviiva1="2W2101";
  break;
case "Express-paketti":
  $tuoteviiva1="2W2102";
  break;
//case "00/16":
//  $tuoteviiva1="2W2105";
//  $tuoteviiva2=">62W>52105";
//  break;
case "Postipaketti":
  $tuoteviiva1="2W2103";
  break;
case "Kotipaketti":
  $tuoteviiva1="2W2104";
  break;
case "VV":
  $tuoteviiva1="2W2116";
  break;
case "LISƒARVOKULJETUS":
  $tuoteviiva1="2W2150";
  break;
case "Palautus":
  $tuoteviiva1="2W2108";
  break;
case "UNDELIVERED SHIPMENT":
  $tuoteviiva1="2W2108";
  break;
case "PRIORITY":
  $tuoteviiva1="2W2015";
  break;
}

if ($toitarow['kuljyksikko'] != '') {
  $kuljetus  = "Kuljetusyksikkˆ";

  //Express City 00 kuljetusyksikkˆ      2W2124
  //Express Morning 9 kuljetusyksikkˆ      2W2143
  //Express Business Day 14 kuljetusyksikkˆ  2W2144
  //Express Flex 21 kuljetusyksikkˆ      2W2145
  //VAK/ADR kuljetusyksikkˆ            2W2146
  //Lis‰arvokuljetus kuljetusyksikkˆ      2W2149
  //Asiakaspalautus 14 kuljetusyksikkˆ     2W2147

  //Uudet
  //Express-rahti 2W2144
  //Express-rahti Aamuksi 09  2W2143
  //Express-rahti Illaksi 21  2W2145
  //Express-rahti Samana P‰iv‰n‰ 00  2W2142

  switch ($keku) {
  case "00":
    $tuoteviiva1="2W2124";
    break;
  case "9":
    $tuoteviiva1="2W2143";
    break;
  case "14":
    $tuoteviiva1="2W2144";
    break;
  case "21":
    $tuoteviiva1="2W2145";
    break;
  case "VV":
    $tuoteviiva1="2W2146";
    break;
  case "LISƒARVOKULJETUS":
    $tuoteviiva1="2W2149";
    break;
  case "ASIAKASPALAUTUS 14":
    $tuoteviiva1="2W2147";
    break;
  case "UNDELIVERED SHIPMENT":
    $tuoteviiva1="2W2147";
    break;
  case "PRIORITY ULKOMAA":
    $tuoteviiva1="2W2015";
    break;
  }
}

if (count($vakit) > 0) {
  // T‰m‰ tyhjennet‰‰n kun tulostetaan VAK/ADR rahtikirja
  $keku = "";
}

if ($rahdinmaksaja == 'L‰hett‰j‰') {
  $rahdinmaksaja    = "";
  $rahdinmaksajan_nr   = "";
}
elseif (trim($rakir_row['rahtisopimus']) != "") {
  $rahdinmaksaja    = "Maksaja muu kuin l‰hett‰j‰. ";
  $rahdinmaksajan_nr   = $rakir_row['rahtisopimus'];
}
else {
  $rahdinmaksaja    = "Maksaja muu kuin l‰hett‰j‰. ";
  $rahdinmaksajan_nr   = "";
}

// Ulkomaan l‰hetykiss‰ tarvitaan myˆs nelinumeroinen, asiakaskohtainen tunnushallintanumero
if (strpos($toitarow['sopimusnro'], "@") !== FALSE) {
  list($toitarow['sopimusnro'], $toitarow['tunhalnro']) = explode("@", $toitarow['sopimusnro']);
}

$toitarow['sopimusnro'] = sprintf("%06s", $toitarow['sopimusnro']);  // sopimunumeron tulee olla kuus pitk‰
$sopnro  = $toitarow['sopimusnro']; // k‰ytet‰‰n edi sanomassa
