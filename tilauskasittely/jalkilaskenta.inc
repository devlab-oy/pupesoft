<?php

/* Tälle on anenttava

$tuoteno 	= korjattava tuote
$pvm 		= mihin päivään asti korjataan
$uusihinta 	= mikä on tuon pvm:n oikea ostohinta
$rivitunnus = mikä on tapahtuman tehneen rivin tunnus

Palautetaan $jlerror, joka on 1, jos jotain epätavallista sattui

*/

$jalkilaskenta_debug = 0; // 0 = ei echoilla debug koodia, 1 = ehchoillaa infoa, 2 = echoillaan infoa plus queryt

if (!function_exists("kopioitiliointi")) {

	function kopioitiliointi ($tunnus, $viivaaja) {

		//Tehdään kopio tiliöinnistä $tunnus
		//Jos $viivaajassa on jotain tehdään uusi vienti yliviivattuna

		global $kukarow;

		$query = "SELECT * FROM tiliointi WHERE yhtio = '$kukarow[yhtio]' and tunnus = '$tunnus'";
		$result = mysql_query($query) or pupe_error($query);

		if (mysql_num_rows($result) != 1) {
			echo "Tiliöintirivi kateissa Systeemivirhe!";
		}
		else {
			$tiliointirow = mysql_fetch_array($result);

			$query = "INSERT into tiliointi set ";

			for ($i=0; $i<mysql_num_fields($result); $i++) {

				if (mysql_field_name($result, $i) != 'tunnus') {

					if ($viivaaja != '') {

						if (mysql_field_name($result, $i) == 'korjattu') {
							$query .= "korjattu ='$viivaaja',";
						}
						elseif (mysql_field_name($result, $i) == 'korjausaika') {
							$query .= "korjausaika = now(),";
						}
						else {
							$query .= mysql_field_name($result,$i) . "='" . $tiliointirow[$i] . "',";
						}
					}
					else {
						$query .= mysql_field_name($result,$i) . "='" . $tiliointirow[$i] . "',";
					}

				}
			}

			$query  = substr($query,0,-1);
			$result = mysql_query($query) or pupe_error($query);
		}
	}
}

if (!function_exists("korjaalaskut")) {

	function korjaalaskut($tuoteno, $kehahin, $alku, $loppu, $korjtunnus) {

		global $kukarow, $yhtiorow, $jalkilaskenta_debug, $jalkilaskenta_debug_text;
		$jlerror=0;

		//Etsitään tuotteen tiliöintitiedot
		$query = "	SELECT tuoteno, tilino, kustp, kohde, projekti, osasto, try
					FROM tuote
					WHERE yhtio = '$kukarow[yhtio]'
					and tuoteno = '$tuoteno'";
		$result = mysql_query($query) or pupe_error($query);

 		// So far so good
		if (mysql_num_rows($result) == 1) {

			$tuote = mysql_fetch_array ($result);

			if ($korjtunnus != 0) {
				$lisa = " and tunnus = '$korjtunnus' ";
			}
			else {
				$lisa = "";
			}

			//etstään tuotteen kaikki myyntitilausrivit
			$query= "	SELECT otunnus oltunnus, uusiotunnus ltunnus, tunnus ttunnus, kpl, kate, rivihinta, laskutettuaika, alv
						FROM tilausrivi use index (yhtio_tyyppi_tuoteno_laskutettuaika)
						WHERE yhtio = '$kukarow[yhtio]'
						and tyyppi = 'L'
						and tuoteno = '$tuoteno'
						and laskutettuaika >= left('$alku',10)
						and laskutettuaika <= left('$loppu',10)
						$lisa";
			$tilausriviresult = mysql_query($query) or pupe_error($query);

			if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
			if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>".t("Löydettiin tuotteelle")." $tuoteno ".mysql_num_rows($tilausriviresult)." ".t("tilausriviä").".</font><br>";

			while ($tilausrivi = mysql_fetch_array ($tilausriviresult)) {

				// haetaan laskun tiedot
				$query    = "select * from lasku where yhtio='$kukarow[yhtio]' and tunnus='$tilausrivi[ltunnus]'";
				$laskures = mysql_query($query) or pupe_error($query);
				$lasku    = mysql_fetch_array($laskures);

				// katotaan saadaanko tehdä tiliöintejä
				// tehdään tilikausi_alku ja korjauksen_alku muuttujista PHP:ssä vertailukelpoisia
				list($tkvv,$tkkk,$tkpp) = explode("-",$yhtiorow["tilikausi_alku"]);
				list($klvv,$klkk,$klpp) = explode("-",$tilausrivi["laskutettuaika"]);

				$tilikausi_alku = (int) date('Ymd',mktime(0,0,0,$tkkk,$tkpp,$tkvv));
				$korjaus_alku   = (int) date('Ymd',mktime(0,0,0,$klkk,$klpp,$klvv));

				// yritetään korjata jotain joka on lukitulla tilikaudella.. estetään se
				if ($korjaus_alku < $tilikausi_alku) {
					echo "<font class='error'>".t("Korjauksia tiliöinteihin/katteisiin ei voida tehdä, koska myyntilasku on lukitulla tilikaudella")."! (".t("Lasku").": $tilausrivi[ltunnus] ".t("Tapvm").": $tilausrivi[laskutettuaika])</font><br>";
				}
				else {

					//Ok, löydämmekö vastaavan tiliöinnin laskulta
					$query = "	SELECT *
								FROM tiliointi
				 				WHERE yhtio 	= '$kukarow[yhtio]'
				 				AND ltunnus		= '$tilausrivi[ltunnus]'
				 				AND tilino 		= '$yhtiorow[varastonmuutos]'
				 				AND kustp 		= '$tuote[kustp]'
				 				AND kohde 		= '$tuote[kohde]'
				 				AND projekti 	= '$tuote[projekti]'
								AND korjattu 	= ''
								ORDER BY summa DESC
								LIMIT 1";
					$result = mysql_query($query) or pupe_error($query);

					// otetaan löydettyjen rivien määrä talteen
					$tilikpl = mysql_num_rows($result);

					// lasketaan uusi kate
					$uusikate = $tilausrivi['rivihinta'] - $tilausrivi['kpl'] * $kehahin;

					// katotaan mikä on muutos
					$muutos = round($uusikate - $tilausrivi["kate"], $yhtiorow['hintapyoristys']); // roundataan yhtiön desimaaliin, koska meillä ei ole sen tarkempaa infoa tietokannassa niin vältytään turhilta muutoksilta

					// debug
					if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Uusikate = $tilausrivi[rivihinta] - $tilausrivi[kpl] * $kehahin (muutos = $muutos)</font><br>";

					// jos ei löydetä varastonmuutostiliöintiä ja kate on muuttunut...
					if ($tilikpl == 0 and $muutos <> 0) {

						// tutkaillaan ensiks josko kustannuspaikat, kohteet tai projektit on muuttunut...
						$query = "	SELECT *
									FROM tiliointi
					 				WHERE yhtio  = '$kukarow[yhtio]'
					 				and ltunnus  = '$tilausrivi[ltunnus]'
					 				and tilino   = '$yhtiorow[varastonmuutos]'
									and korjattu = ''
									ORDER BY summa desc
									LIMIT 1";
						$result = mysql_query($query) or pupe_error($query);

						// löydettiin varastonmuutos tiliöintijä.. otetaan kpl talteen ja jatketaan chekeissä eteenpän
						if (mysql_num_rows($result) != 0) {
							$tilikpl = mysql_num_rows($result);
						}
						else {
							// ei löydetty yhtään varastonmuutos tiliöintiä.. lisätään se nyt.
							$tiliointisumma = $muutos;

							// echotaan tää toistaiseksi aina.. että joku zekkaa, että menee oikein.
							if ($jalkilaskenta_debug >= 1)
								$jalkilaskenta_debug_text .= "<font class='message'>luodaan uudet tiliöinnit, tarkista pliis että meni oikein. laskunro: $lasku[laskunro] ($lasku[nimi]) varasto: $tiliointisumma varastonmuutos: $muutos</font><br>";

							// Kirjataan 'varasto'-tilille
							$query = "INSERT into tiliointi set
										yhtio 		= '$kukarow[yhtio]',
										ltunnus 	= '$lasku[tunnus]',
										tilino 		= '$yhtiorow[varasto]',
										kustp 		= '$tuote[kustp]',
										kohde 		= '$tuote[kohde]',
										projekti	= '$tuote[projekti]',
										tapvm 		= '$lasku[tapvm]',
										summa		= '$tiliointisumma',
										vero		= 0,
										selite 		= 'Varastostamyynti $lasku[nimi]',
										lukko 		= '',
										laatija 	= '$kukarow[kuka]',
										laadittu 	= now()";
							$laskutusres = mysql_query($query) or pupe_error($query);
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";

							$tiliointisumma = $muutos * -1;

							// Kirjataan 'varastonmuutos'-tilille
							$query = "INSERT into tiliointi set
										yhtio 		= '$kukarow[yhtio]',
										ltunnus		= '$lasku[tunnus]',
										tilino 		= '$yhtiorow[varastonmuutos]',
										kustp 		= '$tuote[kustp]',
										kohde 		= '$tuote[kohde]',
										projekti 	= '$tuote[projekti]',
										tapvm 		= '$lasku[tapvm]',
										summa 		= '$tiliointisumma',
										vero 		= 0,
										selite 		= 'Varastostamyynti $lasku[nimi]',
										lukko 		= '',
										laatija 	= '$kukarow[kuka]',
										laadittu 	= now()";
							$laskutusres = mysql_query($query) or pupe_error($query);
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";

							// korjataan laskun kate
							$query = "UPDATE lasku SET kate = kate - $tilausrivi[kate] + $uusikate WHERE tunnus='$tilausrivi[ltunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

							// korjataan tilauksen kate
							$query = "UPDATE lasku SET kate = kate - $tilausrivi[kate] + $uusikate WHERE tunnus='$tilausrivi[oltunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

							// ja lopuksi korjataan tilausrivin kate
							$query = "UPDATE tilausrivi SET kate = $uusikate WHERE tunnus='$tilausrivi[ttunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

						}
					} // end jos ei löydetty yhtään

					// jos löydetään varastonmuutostiliöinti ja kate on muuttunut.. tehdään tarvittavat muutokset
					if ($tilikpl == 1 and $muutos <> 0) {

						if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>".t("Laskun")." $tilausrivi[ltunnus] ".t("varastonmuutostiliöinti löytyi").".</font><br>";

						$tiliointi1 = mysql_fetch_array($result);

						$query = "	SELECT *
									FROM tiliointi
				 					WHERE yhtio 	= '$kukarow[yhtio]'
									and ltunnus		= '$tilausrivi[ltunnus]'
									and tilino 		= '$yhtiorow[varasto]'
									and kustp 		= '$tuote[kustp]'
									and kohde 		= '$tuote[kohde]'
									and projekti 	= '$tuote[projekti]'
									and korjattu 	= ''
									ORDER BY summa asc
									LIMIT 1";
						$result = mysql_query($query) or pupe_error($query);

						// varmistetaan vielä, että löydetään varastotiliöintikin...
						if (mysql_num_rows($result) == 0) {
							$query = "	SELECT *
										FROM tiliointi
					 					WHERE yhtio 	= '$kukarow[yhtio]'
										and ltunnus		= '$tilausrivi[ltunnus]'
										and tilino 		= '$yhtiorow[varasto]'
										and korjattu 	= ''
										ORDER BY summa asc
										LIMIT 1";
							$result = mysql_query($query) or pupe_error($query);
						}

						// Toivottavasti jotain löyty
						if (mysql_num_rows($result) == 1) {

							if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>".t("Laskun")." $tilausrivi[ltunnus] ".t("varastotiliöinti löytyi").".</font><br>";

							$tiliointi2 = mysql_fetch_array ($result);

							// korjataan varastonmuutostiliöinti
							kopioitiliointi($tiliointi1['tunnus'], $kukarow['kuka']); // kopioidaan vanha tiliöintirivi ja yliviivataan se
							$query = "UPDATE tiliointi SET summa = summa + $tilausrivi[kate] - $uusikate, laadittu=now(), laatija='$kukarow[kuka]' WHERE tunnus='$tiliointi1[tunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

							// korjataan varastotiliöinti
							kopioitiliointi($tiliointi2['tunnus'], $kukarow['kuka']); // kopioidaan vanha tiliöintirivi ja yliviivataan se
							$query = "UPDATE tiliointi SET summa = summa - $tilausrivi[kate] + $uusikate, laadittu=now(), laatija='$kukarow[kuka]' WHERE tunnus='$tiliointi2[tunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

							// korjataan laskun kate
							$query = "UPDATE lasku SET kate = kate - $tilausrivi[kate] + $uusikate WHERE tunnus='$tilausrivi[ltunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

							// korjataan tilauksen kate
							$query = "UPDATE lasku SET kate = kate - $tilausrivi[kate] + $uusikate WHERE tunnus='$tilausrivi[oltunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

							// ja lopuksi korjataan tilausrivin kate
							$query = "UPDATE tilausrivi SET kate = $uusikate WHERE tunnus='$tilausrivi[ttunnus]'";
							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$katekorjres = mysql_query($query) or pupe_error($query);

						}
						else {

							echo "<font class='error'>".t("Emme osanneet korjata kirjanpitoa eikä katteita!")." ".t("Laskulta ei löydy sopivaa tiliöintiä (varasto)")."
							tuoteno:									$tuote[tuoteno],
							tilino: 									$yhtiorow[varastonmuutos],
							kustp:  									$tuote[kustp],
							kohde:  									$tuote[kohde],
							projekti:									$tuote[projekti],
							tiliöinnin summa: 							summa - $tilausrivi[kate] + $uusikate,
							laskun ($tilausrivi[ltunnus]) kate: 		kate - $tilausrivi[kate] + $uusikate,
							tilausrivin ($tilausrivi[ttunnus]) kate: 	$uusikate
							</font><br><br>";

							if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
							$jlerror = 1;
						}
					} // end jos löydettiin yks

					// jos löydetään monta varastonmuutostiliöintiä ja kate on muuttunut...ei osata vielä tehä mitään :(
					if ($tilikpl > 1 and $muutos <> 0) {

						echo "<font class='error'>".t("Emme osanneet korjata kirjanpitoa eikä katteita!")." ".t("Laskulta löytyi monta tiliöintiä (varastonmuutos)")."
						".t("tuoteno").":							    		    $tuote[tuoteno],
						".t("tilino").":										    $yhtiorow[varastonmuutos],
						".t("kustp").":							    			    $tuote[kustp],
						".t("kohde").":							    			    $tuote[kohde],
						".t("projekti").":						    			    $tuote[projekti],
						".t("tiliöinnin summa").":						    	    summa + $tilausrivi[kate] - $uusikate,
						".t("laskun")." ($tilausrivi[ltunnus]) ".t("kate").":	    kate - $tilausrivi[kate] + $uusikate,
						".t("tilausrivin")." ($tilausrivi[ttunnus]) ".t("kate").":	$uusikate
						</font><br><br>";

						if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
						$jlerror = 1;

					} // end jos löydettiin enemmän ku yks

				}
			}
		}
		else {
			echo "<font class='error'>".t("Tuote katosi")."</font><br>";
			if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
			$jlerror = 1;
		}
		return $jlerror;
	}
}

$jlerror=0;

if ($tuoteno != '') {

	if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<hr><font class='message'>".t("Aloitellaan käsittely tuotteelle")." $tuoteno.</font><br>";

	//Tuote
	$query = "	SELECT *
				FROM tuote
				WHERE yhtio = '$kukarow[yhtio]'
				and tuoteno = '$tuoteno'";
	$result = mysql_query($query) or pupe_error($query);
	$tuote = mysql_fetch_array($result);

	if (mysql_num_rows($result) == 1 and ($tuote["sarjanumeroseuranta"] == "S" or $tuote["sarjanumeroseuranta"] == "U" or $tuote["sarjanumeroseuranta"] == "G")) {
		//Tähän haaraan mennään jos tuotteella on sarjanumeroseurantaa ja varastonarvo lasketaan suoraan osto ja myyntiriveiltä
		if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "Tuotenumero $tuoteno on sarjanumeroseurannassa<br>";

		$query  = "	SELECT yhtio
					FROM tilausrivi
					WHERE yhtio 		= '$kukarow[yhtio]'
					and ((tyyppi = 'O' and kpl > 0) or (tyyppi = 'L' and kpl < 0))
					and laskutettuaika != '0000-00-00'
					and tunnus 			= '$rivitunnus'
					and tuoteno 		= '$tuoteno'";
		$rxiviresult = mysql_query($query) or pupe_error($query);

		if (mysql_num_rows($rxiviresult) == 1 and is_numeric($uusihinta)) {
			// Päivitetään ostotilausrivin rivihinta
			$query  = "	UPDATE tilausrivi
						SET rivihinta = round($uusihinta*kpl,2)
						WHERE yhtio = '$kukarow[yhtio]'
						and tunnus 	= '$rivitunnus'
						and tuoteno = '$tuoteno'";
			$result = mysql_query($query) or pupe_error($query);

			$selite_txt = ",<br>Jälkilaskennan ostohinta: $uusihinta (".tv1dateconv(date("Y-m-d")).")";

			// Päivitetään korjattava tapahtuma
			$query = "	UPDATE tapahtuma
						SET kplhinta = '$uusihinta', hinta = '$uusihinta', selite = concat(selite, '$selite_txt')
						WHERE yhtio 	= '$kukarow[yhtio]'
						and laji  	   in ('tulo','valmistus')
						and laadittu   >= '$yhtiorow[tilikausi_alku]'
						and tuoteno 	= '$tuoteno'
						and rivitunnus 	= '$rivitunnus'";
			$paivresult = mysql_query($query) or pupe_error($query);

			// Haetaan kaikki tiedot sarjanumerosta
			$query = "	SELECT distinct myyntirivitunnus
						FROM sarjanumeroseuranta
						WHERE yhtio 		= '$kukarow[yhtio]'
						and tuoteno 		= '$tuoteno'
						and ostorivitunnus  = '$rivitunnus'
						and ostorivitunnus != 0";
			$sarjares = mysql_query($query) or pupe_error($query);
			if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";

			while ($sarjarow = mysql_fetch_array($sarjares)) {
				// Hetaaan laskutetut myntirivit
				$query = "	SELECT *
							FROM tilausrivi
							WHERE yhtio 		 = '$kukarow[yhtio]'
							and tunnus 			 = '$sarjarow[myyntirivitunnus]'
							and tyyppi 			 = 'L'
							and uusiotunnus		!= 0
							and laskutettuaika	!= '0000-00-00'
							and kpl 			!= 0";
				$rivires = mysql_query($query) or pupe_error($query);
				if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";

				if (mysql_num_rows($rivires) == 1) {
					$rivirow = mysql_fetch_array($rivires);

					// Haetaan nyt tämän myyntirivin kaikki ostohinnat
					$uusisarjahin = sarjanumeron_ostohinta("myyntirivitunnus", $rivirow["tunnus"]);

					if ($uusisarjahin != 0 and $uusihinta <> $uusisarjahin) {
						if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Tän tuotteen ostohinta:$uusihinta - Myyyntirivin ($rivirow[tunnus]) ostohinta keskimäärin:$uusisarjahin</font><br>";

						$uusihinta = $uusisarjahin;
					}

					$uusikehahin = $uusihinta;

					// Korjaus
					if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Korjataan in-out hintoja! Laskuja (1) Uusi hinta: $uusihinta $rivirow[uusiotunnus]</font><br>";

					$mitenkavi = korjaalaskut($tuoteno, $uusihinta, $rivirow["laskutettuaika"], $rivirow["laskutettuaika"], $rivirow["tunnus"]);

					$query = "	UPDATE tapahtuma
								SET hinta = '$uusihinta'
								WHERE yhtio = '$kukarow[yhtio]'
								and rivitunnus = '$sarjarow[myyntirivitunnus]'
								and laji in ('tulo', 'valmistus', 'laskutus', 'inventointi', 'siirto')
								and laadittu >= '$yhtiorow[tilikausi_alku]'";
					if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
					$upresu = mysql_query($query) or pupe_error($query);
				}
				else {
					if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Ei korjattavaa (tuotetta ei ole myyty)! Uusi hinta: $uusihinta $rivirow[uusiotunnus]</font><br>";
				}
			}
		}
		else {
			echo "<font class='error'>".t("Tilausriviä tai hintaa ei löydy")."</font><br>";
			$jlerror=1;
		}
	}
	elseif (mysql_num_rows($result) == 1) {
		//Tähän haaraan mennään jos tuotteella ei ole sarjanumeroseurantaa eli ylläpidetään keskihankintahintaa tuotteella

		//Alkusaldo
		$query  = "SELECT sum(saldo) saldo FROM tuotepaikat WHERE yhtio = '$kukarow[yhtio]' and tuoteno = '$tuoteno'";
		$result = mysql_query($query) or pupe_error($query);
		$saldo  = mysql_fetch_array ($result);

		//Kääntöpiste
		$query = "SELECT * FROM tapahtuma WHERE yhtio = '$kukarow[yhtio]' and laji in ('tulo','valmistus') and tuoteno = '$tuoteno' and rivitunnus='$rivitunnus'";
		$result = mysql_query($query) or pupe_error($query);

		//taaksepäin yhteensopivuuden vuoksi kokeillaan vielä näin jos ei rivitunnuksella löydy
		if (mysql_num_rows($result) == 0) {
			echo "<font class='error'>".t("Tarkkaa kääntöpisteen tapahtumaa ei löytynyt! Käytetään päivän ensimmäistä tuloa")." $rivitunnus @ $pvm.</font><br>";

			$query = "SELECT * FROM tapahtuma WHERE yhtio = '$kukarow[yhtio]' and tuoteno = '$tuoteno' and left(laadittu,10)='$pvm' and laji in ('tulo','valmistus') limit 1";
			$result = mysql_query($query) or pupe_error($query);
		}
		//Jos samalla rivitunuksella löytyy monta tapahtumaa, niin oletamme että olemme saaneet sisään $tapahtumatunnus muuttujan
		elseif (mysql_num_rows($result) > 1) {
			echo "<font class='error'>".t("Samalla rivitunnuksella löytyi useita kääntöpisteitä! Käytämme sekä rivitunnusta että tapahtumatunnusta.")."</font><br>";

			$query = "SELECT * FROM tapahtuma WHERE yhtio = '$kukarow[yhtio]' and laji in ('tulo','valmistus') and tuoteno = '$tuoteno' and rivitunnus='$rivitunnus' and tunnus='$tapahtumatunnus'";
			$result = mysql_query($query) or pupe_error($query);
		}

		if (mysql_num_rows($result) == 0) {
			echo "<font class='error'>".t("Ei tuloa tuolla päivällä")."</font><br>";
			if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
			$jlerror=1;
		}
		else {
			$tapahtuma = mysql_fetch_array($result);
			$pvm = $tapahtuma["laadittu"]; // kääntöpisteen tarkka aika talteen

			// verrataan vähän aikoja
			list($tkvv,$tkkk,$tkpp) = explode("-",$yhtiorow["tilikausi_alku"]);
			list($klvv,$klkk,$klpp) = explode("-",$tapahtuma["laadittu"]);

			$tilikausi_alku = (int) date('Ymd',mktime(0,0,0,$tkkk,$tkpp,$tkvv));
			$korjaus_alku   = (int) date('Ymd',mktime(0,0,0,$klkk,$klpp,$klvv));

			// yritetään korjata jotain joka on lukitulla tilikaudella.. kerrotaan siitä
			if ($korjaus_alku < $tilikausi_alku) {
				echo "<font class='error'>".t("Korjauksia kaikkiin tapahtumiin ei voida tehdä, koska tapahtumia on lukitulla tilikaudella")."!</font><br>";
			}
		}

		if (($tuote['epakurantti25pvm'] != '0000-00-00') or ($tuote['epakurantti50pvm'] != '0000-00-00') or ($tuote['epakurantti75pvm'] != '0000-00-00') or ($tuote['epakurantti100pvm'] != '0000-00-00')) {
			echo "<font class='error'>".t("Tätä tuotetta ei enää voi korjata")."</font><br>";
			if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
			$jlerror=1;
		}

		if ($jlerror != 1) {

			$query = "	SELECT sum(kpl) saldomuutos, sum(if(laji='Epäkurantti',1,0)) epaku
						FROM tapahtuma
						WHERE yhtio = '$kukarow[yhtio]'
						and tuoteno = '$tuoteno'
						and laadittu >= '$pvm'
						and kpl <> 0
						ORDER BY laadittu desc";
			$result = mysql_query($query) or pupe_error($query);

			if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";

			if (mysql_num_rows($result) > 0) {

				$trow = mysql_fetch_array ($result);

				// epäkuranttisuutta ei osata poistaa --> We are fucked!
				if ($trow['epaku'] > 0) {
					echo "<font class='error'>".t("Tuotteella on epäkuranntisuuden muutos. Emme osaa toimia!")."</font><br>";
					$jlerror=1;
				}

				$seliselilisa = "";
				$uusisaldo = $saldo["saldo"];

				if ($trow["saldomuutos"] != 0) {
					$uusisaldo -= $trow["saldomuutos"];
					$seliselilisa = " ($saldo[saldo] - $trow[saldomuutos]) ";
				}

				// tämä muuttuja tulee valmistusten korjauksesta, ja muutellaan saldoa jos niin pitää tehdä
				if ($kaantopisteen_saldomuutos != 0) {
					$uusisaldo += $kaantopisteen_saldomuutos;
					$seliselilisa .= " + $kaantopisteen_saldomuutos ";
				}

				// haetaan tuotteelle edellinen kehahin
				$query = "	SELECT hinta
							FROM tapahtuma
							WHERE yhtio = '$kukarow[yhtio]'
							and tuoteno = '$tuoteno'
							and laadittu < '$pvm'
							and hinta <> 0
							ORDER BY laadittu desc
							LIMIT 1";
				$result = mysql_query($query) or pupe_error($query);

				if (mysql_num_rows($result) > 0) {
					$trow = mysql_fetch_array($result);
					$uusikehahin = $trow["hinta"];
				}
				else {
					$uusikehahin = 0;
				}

				// Nyt ollaan takaisin peruspäivässä.
				if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<br><font class='error'>".t("Olemme kääntöpisteessä. Saldo kääntöpisteessä:")." $uusisaldo $seliselilisa ".t("Kehahin kääntöpisteessä:")." $uusikehahin</font><br>";

				if ($jlerror == 0) {
					// Päivitetään korjattava tapahtuma
					$selite_txt = ",<br>Jälkilaskennan ostohinta: $uusihinta (".tv1dateconv(date("Y-m-d")).")";
					$query = "UPDATE tapahtuma SET kplhinta = '$uusihinta', selite = concat(selite, '$selite_txt') WHERE tunnus = '$tapahtuma[tunnus]' and laadittu >= '$yhtiorow[tilikausi_alku]'";
					$result = mysql_query($query) or pupe_error($query);

					// haetaan ostotilausrivin tiedot
					$query = "SELECT * from tilausrivi WHERE yhtio='$kukarow[yhtio]' and tunnus='$rivitunnus'";
					$result = mysql_query($query) or pupe_error($query);
					$apujlrow = mysql_fetch_array($result);

					// lasketaan uusi rivihinta
					$testiapukala = round($uusihinta * $apujlrow["kpl"], $yhtiorow['hintapyoristys']);

					// päivitetään ostotilausrivin rivihinta
					$query  = "UPDATE tilausrivi set rivihinta = '$testiapukala' WHERE yhtio='$kukarow[yhtio]' and tunnus='$rivitunnus'";
					$result = mysql_query($query) or pupe_error($query);

					// Nyt lasketaan kaikki hankintahinnat uusiksi
					$query = "	SELECT tuoteno, laadittu, laji, kpl, kplhinta, hinta, tunnus, rivitunnus
								FROM tapahtuma
								WHERE yhtio = '$kukarow[yhtio]'
								and tuoteno = '$tuoteno'
								and laadittu >= '$pvm'
								and kpl <> 0
								ORDER BY laadittu";
					$result = mysql_query($query) or pupe_error($query);
					if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";

					if (mysql_num_rows($result) > 0) {
						$jlerror = 0;
						$eka = 1;
						$korjattavia_laskuja = 0;
						$vlaadittu = '3000-01-01'; // varmuuden vuoks ettei korjailla nollasta lähtien jos käy jotain todellaa weird...

						if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Lasketaan uudet hinnat tuotteelle: $tuote[tuoteno] Sort: Asc</font><br><br>";

						while (($trow = mysql_fetch_array($result)) and ($jlerror == 0)) {

							// kun löydetään eka tulo, voidaan alkaa hommiin...
							if (($trow['laji'] == 'tulo' or $trow['laji'] == 'valmistus') and $eka == 1) {
								$vlaadittu = $trow['laadittu'];
								$eka = 0;
							}

							// jos kyseessä on tulo ja ollaan jo löydetty eka tulo
							if (($trow['laji'] == 'tulo' or $trow['laji'] == 'valmistus') and $eka == 0) {

								// jos ollaan käsitelty jo jotain laskuja, niin nyt on sitte alkamassa uusi tulo ni korjataan laskut ja nollataan laskurit
								if ($korjattavia_laskuja != 0) {
									if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Korjataan! Saldo: $uusisaldo Keskihinta: $uusikehahin Alku: $vlaadittu Loppu: $trow[laadittu] Case: 1</font><br>";
									$mitenkavi = korjaalaskut($tuoteno, $uusikehahin, $vlaadittu, $trow['laadittu'], 0);
									$korjattavia_laskuja = 0;
								}

								if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Tulo. $trow[kpl] kappaletta. Saldo ennen tuloa: $uusisaldo Kehahin ennen tuloa: $uusikehahin Sort: Asc</font><br>";

								// kehahin matikka. lasketaan uusi kehahin jos jakolaskun molemmat puolet on plussalla, sekä saldo ENNEN tapahtumaa on plussalla
								if ($uusisaldo != 0 and $uusisaldo + $trow['kpl'] != 0 and $uusikehahin * $uusisaldo + $trow['kplhinta'] * $trow['kpl'] != 0) {

									if ($jalkilaskenta_debug >= 1) {
										$jalkilaskenta_debug_text .= "<font class='message'>JÄLKILASKENTA: Uusi kehahin (Matikka): ($uusikehahin * $uusisaldo + $trow[kplhinta] * $trow[kpl]) / ($uusisaldo + $trow[kpl])";
									}

									$uusikehahin = round(($uusikehahin * $uusisaldo + $trow['kplhinta'] * $trow['kpl']) / ($uusisaldo + $trow['kpl']), 6);

									if ($jalkilaskenta_debug >= 1) {
										$jalkilaskenta_debug_text .= " = $uusikehahin</font><br>";
									}

								}
								else {
									// jos saldo on nolla ennen tuloa tai tulon jälkeen niin kehari on ostari
									$uusikehahin = $trow['kplhinta'];

									if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>JÄLKILASKENTA: Uusi kehahin (Ei matikkaa): uusikehahin = ostohinta = $uusikehahin</font><br>";
								}

								// otetaan tämä päivä laskennan alkupäiväksi
								$vlaadittu = $trow['laadittu'];

								// summaillaan uutta saldoa
								$uusisaldo += $trow['kpl'];

							} // end if laji == tulo

							// jos kyseessä on laskutus ja ollaan löydetty eka tulo, summaillaan kappaleita
							if ($trow['laji'] == 'laskutus' and $eka == 0) {
								// haetaan myyntitilausrivi
								$query = "	SELECT kpl, rivihinta, kate
											from tilausrivi
											where yhtio	= '$kukarow[yhtio]'
											and tunnus 	= '$trow[rivitunnus]'";
								$myyntitil_apures = mysql_query($query) or pupe_error($query);
								$myyntitil_apurow = mysql_fetch_array($myyntitil_apures);
								$myyntitil_uusikate = $myyntitil_apurow['rivihinta'] - $myyntitil_apurow['kpl'] * $uusikehahin;

								// plussaillaan tätä vaan jos keskihankintahinta tai kate muuttuu, niin tiedetään pitääkö tehdä jälkilaskentaa
								if ($trow["hinta"] != $uusikehahin or $myyntitil_apurow["kate"] != $myyntitil_uusikate) {
									$korjattavia_laskuja++;
								}

								// summaillaan uutta saldoa
								$uusisaldo += $trow['kpl'];
							}

							// jos kyseessä on inventointi ja ollaan löydetty jo eka tulo
							if ($trow['laji'] == 'Inventointi' and $eka == 0) {
								// etsitään tuotteen tiliöinti
								$query = "	SELECT *
											from lasku use index (yhtio_tila_tapvm)
											where yhtio	= '$kukarow[yhtio]'
											and tila 	= 'X'
											and tapvm  >= '".substr($trow["laadittu"], 0, 10)."'
											and viite 	= '$trow[tunnus]'";
								$invresult = mysql_query($query) or pupe_error($query);

								if (mysql_num_rows($invresult) == 1) {
									// löydettiin inventointi tosite
									$invrow = mysql_fetch_array($invresult);

									if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Korjattiin tiliöinti! ".t("Inventoitu").": $trow[tuoteno] @ $trow[laadittu]</font><br>";

									// haetaan varastotiliöinti
									$query = "SELECT * from tiliointi WHERE yhtio='$kukarow[yhtio]' and ltunnus='$invrow[tunnus]' and tilino='$yhtiorow[varasto]' and korjattu=''";
									if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
									$invupd = mysql_query($query) or pupe_error($query);
									$invrow = mysql_fetch_array($invupd);

									// katotaan saadaanko tehdä tiliöintejä
									// tehdään tilikausi_alku ja korjauksen_alku muuttujista PHP:ssä vertailukelpoisia
									list($tkvv,$tkkk,$tkpp) = explode("-",$yhtiorow["tilikausi_alku"]);
									list($klvv,$klkk,$klpp) = explode("-",$trow["laadittu"]);

									$tilikausi_alku = (int) date('Ymd',mktime(0,0,0,$tkkk,$tkpp,$tkvv));
									$korjaus_alku   = (int) date('Ymd',mktime(0,0,0,$klkk,$klpp,$klvv));

									// yritetään korjata jotain joka on lukitulla tilikaudella.. estetään se
									if ($korjaus_alku < $tilikausi_alku) {
										echo "<font class='error'>".t("Korjauksia tiliöinteihin ei voida tehdä, koska tapahtuma on lukitulla tilikaudella")."! (".t("Inventointi").": $trow[laadittu])</font><br>";
									}
									else {
										// yliviivataan kaikki tositteen aktiivit tiliöinnit
										$query = "UPDATE tiliointi SET korjattu='$kukarow[kuka]', korjausaika=now() WHERE yhtio='$kukarow[yhtio]' and ltunnus='$invrow[ltunnus]' and korjattu=''";
										if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
										$invupd = mysql_query($query) or pupe_error($query);

										if ($yhtiorow["varastonmuutos_inventointi"] != "") {
											$varastonmuutos_tili = $yhtiorow["varastonmuutos_inventointi"];
										}
										else {
											$varastonmuutos_tili = $yhtiorow["varastonmuutos"];
										}

										// kirjotetaan uudet tiliönnit
										$query = "	INSERT INTO tiliointi SET
													yhtio    = '$kukarow[yhtio]',
													ltunnus  = '$invrow[ltunnus]',
													tilino   = '$varastonmuutos_tili',
													kustp    = 0,
													tapvm    = '$invrow[tapvm]',
													summa    = $trow[kpl] * $uusikehahin * -1,
													vero     = 0,
													lukko    = '',
													selite   = '$invrow[selite]',
													laatija  = '$kukarow[kuka]',
													laadittu = now()";
										if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
										$invupd = mysql_query($query) or pupe_error($query);

										// kirjotetaan uudet tiliönnit
										$query = "	INSERT INTO tiliointi SET
													yhtio    = '$kukarow[yhtio]',
													ltunnus  = '$invrow[ltunnus]',
													tilino   = '$yhtiorow[varasto]',
													kustp    = 0,
													tapvm    = '$invrow[tapvm]',
													summa    = $trow[kpl] * $uusikehahin,
													vero     = 0,
													lukko    = '',
													selite   = '$invrow[selite]',
													laatija  = '$kukarow[kuka]',
													laadittu = now()";
										if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
										$invupd = mysql_query($query) or pupe_error($query);
									}
								}
								else {
									$invapuluku = $trow["kpl"] * $uusikehahin;
									echo "<font class='error'>".t("Törmättiin inventointitapahtumaan, mutta ei osattu korjata sen tiliöintejä! Korjaa tiliöinti käsin!")." ".t("Inventoitu").": $trow[tuoteno] @ $trow[laadittu] ".t("Summa").": $trow[kpl] * $uusikehahin = $invapuluku</font><br>";
								}
							}

							// jos kyseessä on kulutus ja ollaan löydetty jo eka tulo
							if ($trow['laji'] == 'kulutus' and $eka == 0 and $trow["hinta"] != $uusikehahin) {

								// HUOM: $korjattavat_valmistukset_ind, $korjattavat_valmistukset MUUTTUJAT OVAT GLOBAALEJA

								$query = "	SELECT otunnus
											from tilausrivi
											where yhtio	= '$kukarow[yhtio]'
											and tunnus 	= '$trow[rivitunnus]'";
								$invres = mysql_query($query) or pupe_error($query);
								$invrow = mysql_fetch_array($invres);

								// Alustetaan jos ei ole olemassa
								if (!is_array($korjattavat_valmistukset)) $korjattavat_valmistukset = array();
								if (!isset($korjattavat_valmistukset_ind)) $korjattavat_valmistukset_ind = 0;

								// Globaali array johon otetaan ne valmistukset jotka pitäisi korjata
								// koska jonkun sen valmistuksen raaka-aineen kehahinta muuttui tässä jälkilaskennassa
								if (($invrow["otunnus"]) > 0 and !in_array($invrow["otunnus"], $korjattavat_valmistukset)) {

									// Katotaan mihin väliin tämä kuuluu työntää
									$xx_ok = FALSE;

									// Insertoitavan valmistuksen valmistusaika
									$query = "	SELECT avg(if(tilausrivi.toimitettuaika='0000-00-00 00:00:00' or tilausrivi.tyyppi not in ('V','W'), NULL, date_format(tilausrivi.toimitettuaika, '%Y%m%d%H%i%s'))) toimitettuaika
												FROM tilausrivi
												JOIN lasku ON lasku.yhtio = tilausrivi.yhtio and lasku.tunnus = tilausrivi.otunnus
												WHERE tilausrivi.yhtio = '$kukarow[yhtio]'
												AND lasku.tunnus = '$invrow[otunnus]'";
									$tilre = mysql_query($query) or pupe_error($query);
									$insaika = mysql_fetch_assoc($tilre);

									for ($xx_ind = $korjattavat_valmistukset_ind; $xx_ind < count($korjattavat_valmistukset); $xx_ind++) {

										$query = "	SELECT avg(if(tilausrivi.toimitettuaika='0000-00-00 00:00:00' or tilausrivi.tyyppi not in ('V','W'), NULL, date_format(tilausrivi.toimitettuaika, '%Y%m%d%H%i%s'))) toimitettuaika
													FROM tilausrivi
													JOIN lasku ON lasku.yhtio = tilausrivi.yhtio and lasku.tunnus = tilausrivi.otunnus
													WHERE tilausrivi.yhtio = '$kukarow[yhtio]'
													AND lasku.tunnus = '".$korjattavat_valmistukset[$xx_ind]."'";
										$tilre = mysql_query($query) or pupe_error($query);
										$thisaika = mysql_fetch_assoc($tilre);

										$query = "	SELECT avg(if(tilausrivi.toimitettuaika='0000-00-00 00:00:00' or tilausrivi.tyyppi not in ('V','W'), NULL, date_format(tilausrivi.toimitettuaika, '%Y%m%d%H%i%s'))) toimitettuaika
													FROM tilausrivi
													JOIN lasku ON lasku.yhtio = tilausrivi.yhtio and lasku.tunnus = tilausrivi.otunnus
													WHERE tilausrivi.yhtio = '$kukarow[yhtio]'
													AND lasku.tunnus = '".$korjattavat_valmistukset[($xx_ind+1)]."'";
										$tilre = mysql_query($query) or pupe_error($query);
										$nextaika = mysql_fetch_assoc($tilre);

										if ($insaika["toimitettuaika"] > $thisaika["toimitettuaika"] and $insaika["toimitettuaika"] < $nextaika["toimitettuaika"]) {
											array_splice($korjattavat_valmistukset, ($xx_ind+1), 0, $invrow["otunnus"]);
											$xx_ok = TRUE;
										}
									}

									if (!$xx_ok) {
										$korjattavat_valmistukset[] = $invrow["otunnus"];
									}

									if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>".t("Törmättiin kulutustapahtumaan, valmistus pitäisi laskea uudestaan").": $invrow[otunnus]!</font><br>";
								}
							}

							// jos ollaa löydetty eka tulo voidaan aina päivitetään tapahtuma jos se on tulo, valmistus, laskutus, inventointi, kulutus tai siirto
							if ($eka == 0) {

								if ($trow["laji"] == "kulutus") {
									$kulutuslisa = ", kplhinta='$uusikehahin' ";
								}
								else {
									$kulutuslisa = "";
								}

								// päivitetään hinta vain jos hinta on eri
								if ($trow["hinta"] != $uusikehahin) {
									$query = "UPDATE tapahtuma SET hinta = '$uusikehahin' $kulutuslisa WHERE tunnus = '$trow[tunnus]' and laji in ('tulo', 'valmistus', 'laskutus', 'inventointi', 'kulutus', 'siirto') and laadittu >= '$yhtiorow[tilikausi_alku]'";
									if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
									$upresu = mysql_query($query) or pupe_error($query);
								}
							}

						} // end while

						// jos meillä on jotain korjattavia laskuja, jota ei korjattu whilen sisällä ni korjataan ne ny
						if ($korjattavia_laskuja != 0 and $eka == 0) {
							if ($jalkilaskenta_debug >= 1) $jalkilaskenta_debug_text .= "<font class='message'>Korjataan! Saldo: $uusisaldo Keskihinta: $uusikehahin Alku: $vlaadittu Loppu: 3000-01-01 Case: 2</font><br>";
							$mitenkavi = korjaalaskut($tuoteno, $uusikehahin, $vlaadittu, '3000-01-01', 0);
						}

					} // end if numrows > 0

					// päivitetään lopulta tuotteelle uusi kehahin ja vihahin
					$query = "UPDATE tuote SET kehahin = '$uusikehahin', vihahin = round('$uusihinta','$yhtiorow[hintapyoristys]'), vihapvm = now() WHERE yhtio = '$kukarow[yhtio]' and tuoteno = '$tuoteno'";
					if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
					$result = mysql_query($query) or pupe_error($query);
				}
				else {
					echo "<font class='error'>".t("Tuotteella ei tapahtumia")."</font><br><br>";
					if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
					$jlerror=1;
				}
			}
			else {
				echo "<font class='error'>".t("Tuotetta ei löydy")."</font><br>";
				if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
				$jlerror=1;
			}
		}
	}
	else {
		echo "<font class='error'>".t("Tuotetta ei löydy")."</font><br>";

		if ($jalkilaskenta_debug > 1) $jalkilaskenta_debug_text .= "$query<br>";
		$jlerror=1;
	}
}

?>
